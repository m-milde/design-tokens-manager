<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>DTM Token Sync - Clean</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #ffffff;
      color: #333;
    }
    
    .container {
      max-width: 360px;
    }
    
    h2 {
      margin: 0 0 20px 0;
      color: #18a0fb;
      font-size: 18px;
      font-weight: 600;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
      text-align: center;
    }
    
    .status.connected {
      background: #e6f7ed;
      color: #0d5c1a;
      border: 1px solid #b3e6c1;
    }
    
    .status.disconnected {
      background: #ffe6e6;
      color: #cc0000;
      border: 1px solid #ffb3b3;
    }
    
    .status.connecting {
      background: #fff3e6;
      color: #cc7700;
      border: 1px solid #ffd699;
    }
    
    .button {
      background: #18a0fb;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      width: 100%;
      margin-bottom: 12px;
      transition: background-color 0.2s;
    }
    
    .button:hover {
      background: #0d8ce0;
    }
    
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .button.secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }
    
    .button.secondary:hover {
      background: #e0e0e0;
    }
    
    .button.danger {
      background: #ff3b30;
    }
    
    .button.danger:hover {
      background: #e02e24;
    }
    
    .button.success {
      background: #34c759;
    }
    
    .button.success:hover {
      background: #2db84e;
    }
    
    .info {
      background: #f0f8ff;
      border: 1px solid #b3d9ff;
      border-radius: 6px;
      padding: 12px;
      margin-top: 20px;
      font-size: 13px;
      color: #0066cc;
    }
    
    .debug {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      margin-top: 12px;
      font-family: monospace;
      font-size: 11px;
      color: #666;
      max-height: 100px;
      overflow-y: auto;
    }
    
    .button-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .button-group .button {
      flex: 1;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üé® DTM Token Sync</h2>
    
    <div id="status" class="status disconnected">
      ‚ùå Not connected to DTM App
    </div>
    
    <button id="connectBtn" class="button">
      üîå Connect to DTM App
    </button>
    
    <div class="button-group">
      <button id="testConnectionBtn" class="button secondary">
        üß™ Test Connection
      </button>
      <button id="createTestTokenBtn" class="button success">
        ‚ûï Test Token
      </button>
    </div>
    
    <button id="syncBtn" class="button secondary" disabled>
      üîÑ Sync Tokens to Figma
    </button>
    
    <button id="disconnectBtn" class="button secondary danger" disabled>
      ‚ùå Disconnect
    </button>
    
    <div class="info">
      <strong>How it works:</strong><br>
      1. Connect to your DTM app running on localhost:8080<br>
      2. Test the connection to verify it's working<br>
      3. Create a test token to verify Figma Variables API<br>
      4. Click "Sync Tokens" to import your token system<br>
      5. Tokens will be created as Figma Variables with Light/Dark modes
    </div>
    
    <div id="debug" class="debug" style="display: none;">
      Debug info will appear here...
    </div>
  </div>

  <script>
    let isConnected = false;
    const debug = document.getElementById('debug');
    
    // Show debug info in development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      debug.style.display = 'block';
    }
    
    function updateStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      
      // Update button states
      const connectBtn = document.getElementById('connectBtn');
      const testConnectionBtn = document.getElementById('testConnectionBtn');
      const createTestTokenBtn = document.getElementById('createTestTokenBtn');
      const syncBtn = document.getElementById('syncBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      
      if (type === 'connected') {
        connectBtn.disabled = true;
        testConnectionBtn.disabled = false;
        createTestTokenBtn.disabled = false;
        syncBtn.disabled = false;
        disconnectBtn.disabled = false;
        isConnected = true;
      } else if (type === 'disconnected') {
        connectBtn.disabled = false;
        testConnectionBtn.disabled = true;
        createTestTokenBtn.disabled = true;
        syncBtn.disabled = true;
        disconnectBtn.disabled = true;
        isConnected = false;
      } else if (type === 'connecting') {
        connectBtn.disabled = true;
        testConnectionBtn.disabled = true;
        createTestTokenBtn.disabled = true;
        syncBtn.disabled = true;
        disconnectBtn.disabled = true;
      }
    }
    
    function logDebug(message) {
      if (debug.style.display !== 'none') {
        debug.textContent = `${new Date().toLocaleTimeString()}: ${message}\n${debug.textContent}`;
      }
    }
    
    async function testConnection() {
      try {
        logDebug('Testing connection to DTM App...');
        updateStatus('üîÑ Testing connection...', 'connecting');
        
        // Send message to plugin to test connection
        parent.postMessage({ pluginMessage: { type: 'test-connection' } }, '*');
        
      } catch (error) {
        logDebug(`Connection test error: ${error.message}`);
        updateStatus(`‚ùå Test failed: ${error.message}`, 'disconnected');
      }
    }
    
    async function createTestToken() {
      try {
        logDebug('Creating test token...');
        updateStatus('üîÑ Creating test token...', 'connecting');
        
        // Send message to plugin to create test token
        parent.postMessage({ pluginMessage: { type: 'create-test-token' } }, '*');
        
      } catch (error) {
        logDebug(`Test token creation error: ${error.message}`);
        updateStatus(`‚ùå Test token failed: ${error.message}`, 'disconnected');
      }
    }
    
    async function connectToApp() {
      try {
        logDebug('Connecting to DTM App...');
        updateStatus('üîÑ Connecting to DTM App...', 'connecting');
        
        const response = await fetch('http://localhost:8080/api/tokens', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        logDebug(`Response status: ${response.status}`);
        logDebug(`Response headers: ${JSON.stringify([...response.headers.entries()])}`);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        logDebug(`Received data: ${JSON.stringify(data).substring(0, 200)}...`);
        
        updateStatus('‚úÖ Connected to DTM App!', 'connected');
        parent.postMessage({ pluginMessage: { type: 'connected' } }, '*');
        
      } catch (error) {
        logDebug(`Connection error: ${error.message}`);
        updateStatus(`‚ùå Failed to connect: ${error.message}`, 'disconnected');
      }
    }
    
    async function syncTokens() {
      if (!isConnected) {
        updateStatus('‚ùå Not connected to DTM App', 'disconnected');
        return;
      }
      
      try {
        updateStatus('üîÑ Syncing tokens...', 'connecting');
        parent.postMessage({ pluginMessage: { type: 'sync-tokens' } }, '*');
        
        // Wait a bit for the sync to complete
        setTimeout(() => {
          if (isConnected) {
            updateStatus('‚úÖ Connected to DTM App!', 'connected');
          }
        }, 2000);
        
      } catch (error) {
        logDebug(`Sync error: ${error.message}`);
        updateStatus(`‚ùå Sync failed: ${error.message}`, 'disconnected');
      }
    }
    
    function disconnect() {
      updateStatus('‚ùå Disconnected from DTM App', 'disconnected');
      parent.postMessage({ pluginMessage: { type: 'disconnected' } }, '*');
    }
    
    // Listen for messages from the plugin
    window.addEventListener('message', (event) => {
      if (event.data.pluginMessage) {
        const msg = event.data.pluginMessage;
        
        if (msg.type === 'connection-success') {
          updateStatus('‚úÖ Connection test successful!', 'connected');
          logDebug(`Connection test successful. Found ${msg.data?.tokens ? Object.keys(msg.data.tokens).length : 0} token layers`);
        }
        
        if (msg.type === 'connection-error') {
          updateStatus(`‚ùå Connection test failed: ${msg.error}`, 'disconnected');
          logDebug(`Connection test failed: ${msg.error}`);
        }
        
        if (msg.type === 'test-token-created') {
          updateStatus('‚úÖ Test token created successfully!', 'connected');
          logDebug('Test token created successfully');
        }
        
        if (msg.type === 'test-token-error') {
          updateStatus(`‚ùå Test token failed: ${msg.error}`, 'disconnected');
          logDebug(`Test token creation failed: ${msg.error}`);
        }
      }
    });
    
    // Event listeners
    document.getElementById('connectBtn').addEventListener('click', connectToApp);
    document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
    document.getElementById('createTestTokenBtn').addEventListener('click', createTestToken);
    document.getElementById('syncBtn').addEventListener('click', syncTokens);
    document.getElementById('disconnectBtn').addEventListener('click', disconnect);
    
    // Initial state
    updateStatus('‚ùå Not connected to DTM App', 'disconnected');
    logDebug('Plugin UI loaded. Ready to connect to DTM App.');
  </script>
</body>
</html>

